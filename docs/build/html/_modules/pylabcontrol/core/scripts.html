
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pylabcontrol.core.scripts &#8212; pylabcontrol 0.1a3 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1a3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pylabcontrol.core.scripts</h1><div class="highlight"><pre>
<span></span>
<span class="c1"># This file is part of pylabcontrol, software for laboratory equipment control for scientific experiments.</span>
<span class="c1"># Copyright (C) &lt;2016&gt;  Arthur Safira, Jan Gieseler, Aaron Kabcenell</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># pylabcontrol is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># pylabcontrol is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with pylabcontrol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>

<span class="kn">from</span> <span class="nn">pylabcontrol.core.instruments</span> <span class="k">import</span> <span class="n">Instrument</span>
<span class="kn">from</span> <span class="nn">pylabcontrol.core.parameter</span> <span class="k">import</span> <span class="n">Parameter</span>
<span class="kn">from</span> <span class="nn">pylabcontrol.core.read_write_functions</span> <span class="k">import</span> <span class="n">save_b26_file</span><span class="p">,</span> <span class="n">load_b26_file</span>
<span class="kn">from</span> <span class="nn">pylabcontrol.core.helper_functions</span> <span class="k">import</span> <span class="n">module_name_from_path</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="k">import</span> <span class="n">pyqtSignal</span><span class="p">,</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">pyqtSlot</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">len</span> <span class="k">as</span> <span class="n">builtin_len</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="k">import</span> <span class="n">FigureCanvasPdf</span> <span class="k">as</span> <span class="n">FigureCanvas</span> <span class="c1"># use this to avoid error that plotting should only be done on main thread</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="k">import</span> <span class="n">Figure</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="k">import</span> <span class="n">import_module</span>


<span class="c1"># cPickle module implements the same algorithm as pickle, in C instead of Python.</span>
<span class="c1"># It is many times faster than the Python implementation, but does not allow the user to subclass from Pickle.</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<div class="viewcode-block" id="Script"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script">[docs]</a><span class="k">class</span> <span class="nc">Script</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="c1">#This is the signal that will be emitted during the processing.</span>
    <span class="c1">#By including int as an argument, it lets the signal know to expect</span>
    <span class="c1">#an integer argument when emitting.</span>
    <span class="n">updateProgress</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># emits a progress update in percent</span>
    <span class="n">started</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>  <span class="c1"># signals the begin of the script</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span> <span class="c1"># signals the end of the script</span>
    <span class="c1"># current_subscript = pyqtSignal(str) # indicates the current subscript that is being excecuted</span>

    <span class="n">_DEFAULT_SETTINGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;path to folder where data is saved&#39;</span><span class="p">),</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;default_tag&#39;</span><span class="p">),</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span><span class="s1">&#39;check to automatically save data&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">RAW_DATA_DIR</span> <span class="o">=</span> <span class="s1">&#39;raw_data&#39;</span> <span class="c1"># dir name for rawdata</span>
    <span class="n">SUBSCRIPT_DATA_DIR</span> <span class="o">=</span> <span class="s1">&#39;data_subscripts&#39;</span> <span class="c1"># dir name for subscript data</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">instruments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scripts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        executes scripts and stores script parameters and settings</span>
<span class="sd">        Args:</span>
<span class="sd">            name (optional):  name of script, if not provided take name of function</span>
<span class="sd">            settings (optional): a Parameter object that contains all the information needed in the script</span>
<span class="sd">            instruments (optional): instruments used in the script</span>
<span class="sd">            scripts (optional):  sub_scripts used in the script</span>
<span class="sd">            log_function(optional): function reference that takes a string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">QObject</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_script_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_instruments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">instruments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">instruments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruments</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_INSTRUMENTS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">instruments</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">data_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">instruments</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_INSTRUMENTS</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_scripts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">scripts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scripts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scripts</span> <span class="o">=</span> <span class="n">scripts</span>

        <span class="c1"># set end time to be before start time if script hasn&#39;t been excecuted this tells us</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">Parameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_SETTINGS</span> <span class="o">+</span> <span class="n">Script</span><span class="o">.</span><span class="n">_DEFAULT_SETTINGS</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()})</span>
        <span class="k">if</span> <span class="n">settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># data hold the data generated by the script,</span>
        <span class="c1"># this should either be a dictionary or a deque of dictionaries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># a log for status outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_data</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="c1"># this can be overwritten</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_function</span> <span class="o">=</span> <span class="n">log_function</span>

        <span class="c1"># default value is &#39;none&#39;, overwrite this in script if it has plotting capabilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_refresh</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_current_subscript_stage</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;current_subscript&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;subscript_exec_count&#39;</span><span class="p">:{},</span>
            <span class="s1">&#39;subscript_exec_duration&#39;</span><span class="p">:{}</span>
        <span class="p">}</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span>

    <span class="nd">@data_path</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">data_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="c1"># check is path is a valid path string</span>
        <span class="c1"># if path is not None and path is not &#39;&#39;:</span>
        <span class="c1">#     if not os.path.isdir(path):</span>
        <span class="c1">#         print(&#39;{:s} created&#39;.format(path))</span>
        <span class="c1">#         os.makedirs(path)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_set_current_subscript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets the current subscript and keeps a counter of how ofter a particular subscript has been executed</span>
<span class="sd">        this information is usefull when implementing a status update or plotting functions that depend on which subscript is being executed</span>

<span class="sd">        keeps track of the following dictionary:</span>
<span class="sd">        self._current_subscript_stage = {</span>
<span class="sd">            &#39;current_subscript&#39; : reference to the current subscrit</span>
<span class="sd">            &#39;subscript_exec_count&#39; : dictionary where key is the subscript name and value how often is has been executed</span>
<span class="sd">            &#39;subscript_exec_duration&#39; : dictionary where key is the subscript name and value the average duration of executing the subscript</span>
<span class="sd">        }</span>

<span class="sd">        Args:</span>
<span class="sd">            active: True if the current subscript is just started, False if it just finished</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">current_subscript</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span>


        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subscript_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_subscript_stage</span><span class="p">[</span><span class="s1">&#39;subscript_exec_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">subscript_name</span> <span class="o">==</span> <span class="n">current_subscript</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_current_subscript_stage</span><span class="p">[</span><span class="s1">&#39;subscript_exec_count&#39;</span><span class="p">][</span><span class="n">subscript_name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_subscript_stage</span><span class="p">[</span><span class="s1">&#39;current_subscript&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_subscript</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_subscript_stage</span><span class="p">[</span><span class="s1">&#39;current_subscript&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_subscript</span>
            <span class="k">for</span> <span class="n">subscript_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_subscript_stage</span><span class="p">[</span><span class="s1">&#39;subscript_exec_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c1"># calculate the average duration to execute the subscript</span>
                <span class="k">if</span> <span class="n">subscript_name</span> <span class="o">==</span> <span class="n">current_subscript</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">duration</span> <span class="o">=</span> <span class="n">current_subscript</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">current_subscript</span><span class="o">.</span><span class="n">start_time</span>
                    <span class="k">if</span> <span class="n">subscript_name</span>  <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_subscript_stage</span><span class="p">[</span><span class="s1">&#39;subscript_exec_duration&#39;</span><span class="p">]:</span>
                        <span class="n">duration_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_subscript_stage</span><span class="p">[</span><span class="s1">&#39;subscript_exec_duration&#39;</span><span class="p">][</span><span class="n">subscript_name</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">duration_old</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">exec_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_subscript_stage</span><span class="p">[</span><span class="s1">&#39;subscript_exec_count&#39;</span><span class="p">][</span><span class="n">subscript_name</span><span class="p">]</span>

                    <span class="n">duration_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">duration_old</span> <span class="o">*</span> <span class="p">(</span><span class="n">exec_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">duration</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_current_subscript_stage</span><span class="p">[</span><span class="s1">&#39;subscript_exec_duration&#39;</span><span class="p">][</span><span class="n">subscript_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">duration_old</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">exec_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">duration</span><span class="p">)</span> <span class="o">/</span> <span class="n">exec_count</span>

    <span class="k">def</span> <span class="nf">_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the actual function that will be executed. It uses only information that is provided in the settings property</span>
<span class="sd">        will be overwritten in the __init__</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># some generic function</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1">#todo: 170202JG (search for this to find related todos)</span>
    <span class="c1"># make this a slot</span>
    <span class="c1"># @pyqtSlot(bool)</span>
<div class="viewcode-block" id="Script.log"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        appends input string to log file and sends it to log function (self.log_function)</span>
<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_function</span><span class="p">(</span><span class="n">string</span><span class="p">)</span></div>

    <span class="c1"># @property</span>
    <span class="c1"># def _DEFAULT_SETTINGS(self):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     returns the default parameter_list of the script this function should be over written in any subclass</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     raise NotImplementedError(&quot;Subclass did not implement _DEFAULT_SETTINGS&quot;)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_INSTRUMENTS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns: a dictionary of the instruments, where key is the instrument name and value is the instrument class</span>
<span class="sd">        if there is not instrument it should return an empty dict</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Subclass did not implement _INSTRUMENTS&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_SCRIPTS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns: a dictionary of the instruments, where the key is the instrument name and value is the instrument class</span>
<span class="sd">        if there is not instrument it should return an empty dict</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Subclass did not implement _SCRIPTS&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: a description of the script in form of a string</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">output_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1"> (class type: </span><span class="si">{:s}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;settings:</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">output_string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2"> : </span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">output_string</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        script name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; is not a string&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">instrumets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: instruments that the script uses as a dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instruments</span>
    <span class="nd">@instrumets</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">instruments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument_dict</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instrument_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="c1"># checks if all the keys in _INSTRUMENTS are contained in instrument_dict</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_INSTRUMENTS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">instrument_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">: needs instruments </span><span class="si">{:s}</span><span class="s2"> but received </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_INSTRUMENTS</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">instrument_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_INSTRUMENTS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instruments</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">instrument_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]})</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: sub_scripts that the script uses as a dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scripts</span>

    <span class="nd">@scripts</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script_dict</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">script_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">script_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SCRIPTS</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">: set subscripts </span><span class="si">{:s}</span><span class="s2">, received </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">script_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SCRIPTS</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SCRIPTS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">script_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SCRIPTS</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scripts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">script_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]})</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :return: returns the settings of the script</span>
<span class="sd">        settings contain Parameters, Instruments and Scripts</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span>

<div class="viewcode-block" id="Script.update"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        updates the internal dictionary</span>
<span class="sd">        Args:</span>
<span class="sd">            settings: parameters to be set</span>
<span class="sd">        # mabe in the future:</span>
<span class="sd">        # Returns: boolean that is true if update successful</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;settings&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;instruments&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instrument_name</span><span class="p">,</span> <span class="n">instrument_setting</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;instruments&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span><span class="p">[</span><span class="n">instrument_name</span><span class="p">][</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">instrument_setting</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;scripts&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">script_name</span><span class="p">,</span> <span class="n">script_setting</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;scripts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scripts</span><span class="p">[</span><span class="n">script_name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">script_setting</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        time when script execution ended</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_stop</span>

    <span class="nd">@end_time</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_stop</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">remaining_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        estimates the time remaining until script is finished</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="c1"># safety to avoid devision by zero</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">estimated_total_time</span> <span class="o">=</span> <span class="mf">100.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">*</span> <span class="n">elapsed_time</span>

        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">estimated_total_time</span> <span class="o">-</span> <span class="n">elapsed_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        time when script execution started</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_start</span>
    <span class="nd">@start_time</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_start</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">excecution_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: script excecition time as time_delta object to get time in seconds use .total_seconds()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>

    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_receive_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        this function takes care of signals emitted by the subscripts</span>
<span class="sd">        the default behaviour is that it just reemits the signal</span>
<span class="sd">        Args:</span>
<span class="sd">            progress: progress of subscript</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(datetime.datetime.now().strftime(&quot;%B %d, %Y %H:%M:%S&quot;), self.name,QtCore.QThread.currentThread(), self._current_subscript_stage[&#39;current_subscript&#39;].name,</span>
        <span class="c1">#       &#39;received signal. emitting....&#39;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateProgress</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>

<div class="viewcode-block" id="Script.run"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        executes the script</span>
<span class="sd">        :return: boolean if execution of script finished succesfully</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_refresh</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># flag that requests that plot axes are refreshed when self.plot is called next time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_current_subscript_stage</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;current_subscript&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;subscript_exec_count&#39;</span><span class="p">:{},</span>
            <span class="s1">&#39;subscript_exec_duration&#39;</span><span class="p">:{}</span>
        <span class="p">}</span>

        <span class="c1"># update the datapath of the subscripts, connect their progress signal to the receive slot</span>
        <span class="k">for</span> <span class="n">subscript</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">subscript</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">create_if_not_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBSCRIPT_DATA_DIR</span><span class="p">)</span>
            <span class="n">subscript</span><span class="o">.</span><span class="n">updateProgress</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_receive_signal</span><span class="p">)</span>
            <span class="n">subscript</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_current_subscript</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">subscript</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_current_subscript</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_subscript_stage</span><span class="p">[</span><span class="s1">&#39;subscript_exec_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">subscript</span><span class="o">.</span><span class="n">name</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_subscript_stage</span><span class="p">[</span><span class="s1">&#39;subscript_exec_duration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">subscript</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)})</span>

                <span class="c1">#todo: 170202JG (search for this to find related todos) need to test this:</span>
                <span class="c1"># do we need to connect the log functions of the subscript to the mother script?, e.g</span>
                <span class="c1"># subscript.log.connect(self.log)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;starting script </span><span class="si">{:s}</span><span class="s1"> at </span><span class="si">{:s}</span><span class="s1"> on </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%y&#39;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">#saves standard to disk</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;save&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_b26</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_function</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span>  <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;script </span><span class="si">{:s}</span><span class="s1"> finished at </span><span class="si">{:s}</span><span class="s1"> on </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%y&#39;</span><span class="p">)))</span>

        <span class="c1">#saves standard to disk</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;save&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_log</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_image_to_disk</span><span class="p">()</span>

        <span class="n">success</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span>

        <span class="c1"># disconnect subscripts</span>
        <span class="k">for</span> <span class="n">subscript</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">subscript</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="n">subscript</span><span class="o">.</span><span class="n">updateProgress</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="n">subscript</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>



<div class="viewcode-block" id="Script.stop"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        stops itself and all the subscript</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">subscript</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">subscript</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;--- stopping: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Script.is_valid"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.is_valid">[docs]</a>    <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        function to validate of the script parameters are valid:</span>
<span class="sd">         - check if the filename is too long (pandas can&#39;t write files if the total filepath is longer than 259 characters)</span>

<span class="sd">        :return: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># validate = True</span>
        <span class="c1"># # check if filename is longer than 220, this leaves a buffer of 39 for dynamically created extentions</span>
        <span class="c1"># if len(self.filename()) &gt; 220:</span>
        <span class="c1">#     validate = False</span>
        <span class="c1">#     self.log(&#39;Validation failed. Detected long filename in &#39;, self.name)</span>
        <span class="c1">#</span>
        <span class="c1"># for s in self.scripts:</span>
        <span class="c1">#     if s.validate == False:</span>
        <span class="c1">#         validate = False</span>
        <span class="c1">#</span>
        <span class="c1"># return validate</span>
        <span class="k">pass</span></div>





<div class="viewcode-block" id="Script.filename"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.filename">[docs]</a>    <span class="k">def</span> <span class="nf">filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appendix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">create_if_not_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        creates a filename based</span>
<span class="sd">        Args:</span>
<span class="sd">            appendix: appendix for file</span>

<span class="sd">        Returns: filename</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if provided path is a relative path and self.data_path exists, build path</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>

        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span><span class="c1">#.replace(&#39;.&#39;,&#39;-&#39;)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">-%H_%M_%S&#39;</span><span class="p">),</span><span class="n">tag</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">create_if_not_existing</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">appendix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>  <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_</span><span class="si">{:s}{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">-%H_%M_%S&#39;</span><span class="p">),</span><span class="n">tag</span><span class="p">,</span><span class="n">appendix</span><span class="p">))</span>

        <span class="c1"># windows can&#39;t deal with long filenames so we have to use the prefix &#39;\\\\?\\&#39;</span>
        <span class="c1"># if len(filename.split(&#39;\\\\?\\&#39;)) == 1:</span>
        <span class="c1">#     filename = &#39;\\\\?\\&#39; + filename</span>

        <span class="k">return</span> <span class="n">filename</span></div>
<div class="viewcode-block" id="Script.to_dict"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns: itself as a dictionary</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">pylabcontrol.core.script_iterator</span> <span class="k">import</span> <span class="n">ScriptIterator</span>


        <span class="k">if</span> <span class="s1">&#39;script_iterator&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="c1"># script iterator module is of the form</span>
            <span class="c1"># &#39;pylabcontrol.core.script_iterator.b26_toolkit.dynamic_script_iterator0&#39;</span>
            <span class="c1"># and the class name if of the form package.dynamic_script_iterator0</span>
            <span class="n">package</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if it is not a script iterator the package is the highest level of the module</span>
            <span class="n">package</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


        <span class="n">dictator</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s1">&#39;filepath&#39;</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">),</span>
            <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">,</span>
            <span class="s1">&#39;package&#39;</span><span class="p">:</span> <span class="n">package</span>
        <span class="p">}}</span>

        <span class="c1"># todo JG: mayby change path so that it points to b26toolkit and not to PyLabcotnrols</span>
        <span class="c1"># if isinstance(self, ScriptIterator):</span>
        <span class="c1">#     dictator[&#39;filepath&#39;] = inspect.getfile(self.__class__),</span>



        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scripts</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="n">dictator</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;scripts&#39;</span><span class="p">:</span> <span class="p">{}</span> <span class="p">})</span>
            <span class="k">for</span> <span class="n">subscript_name</span><span class="p">,</span> <span class="n">subscript</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dictator</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;scripts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">subscript</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="c1"># dictator[self.name].update({&#39;instruments&#39;: self.instruments})</span>
            <span class="c1"># dictator[self.name].update({&#39;instruments&#39;: {} })</span>
            <span class="c1"># for instrument_name, instrument in self.instruments.iteritems():</span>
            <span class="c1">#     dictator[self.name][&#39;instruments&#39;].update(instrument.to_dict())</span>

            <span class="n">dictator</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;instruments&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">instrument_name</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s1">&#39;instance&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;settings&#39;</span><span class="p">:</span><span class="n">instrument</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">]}</span>
                <span class="k">for</span> <span class="n">instrument_name</span><span class="p">,</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}})</span>

        <span class="n">dictator</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span>

        <span class="k">return</span> <span class="n">dictator</span></div>
<div class="viewcode-block" id="Script.save_data"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.save_data">[docs]</a>    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">data_tag</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        saves the script data to a file</span>
<span class="sd">        filename: target filename, if not provided, it is created from internal function</span>
<span class="sd">        data_tag: string, if provided save only the data that matches the tag, otherwise save all data</span>
<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">def</span> <span class="nf">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            overwrite the buildin len function to cover cases that don&#39;t have a length, like int or float</span>
<span class="sd">            and to catch string as objects of length 0</span>
<span class="sd">            Args:</span>
<span class="sd">                x: quantity of which we want to find the length</span>
<span class="sd">            Returns: length of x</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span> <span class="ow">or</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">builtin_len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">RAW_DATA_DIR</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="c1"># windows can&#39;t deal with long filenames so we have to use the prefix &#39;\\\\?\\&#39;</span>
        <span class="c1"># if len(filename.split(&#39;\\\\?\\&#39;)) == 1:</span>
        <span class="c1">#     filename = &#39;\\\\?\\&#39; + filename</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="c1"># if deque object, take the last dataset, which is the most recent</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">deque</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;script data variable has an invalid datatype! Must be deque or dict.&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">data_tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())]))</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="n">i</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())))])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
                <span class="c1"># if all entries of the dictionary are the same length and single column we can write the data into a single file</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]))</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span><span class="n">data</span><span class="p">])</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># otherwise, we write each entry into a separate file</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">value</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                            <span class="c1"># if dictionary values are single numbers</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                            <span class="c1"># if dictionary values are lists or arrays</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># if not a dictionary</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;-</span><span class="si">{:s}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># save only the data for which a key has been provided</span>
            <span class="k">assert</span> <span class="n">data_tag</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data_tag</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">value</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
<div class="viewcode-block" id="Script.save_log"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.save_log">[docs]</a>    <span class="k">def</span> <span class="nf">save_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        save log to file</span>
<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="s1">&#39;-info.txt&#39;</span><span class="p">)</span>
        <span class="c1"># windows can&#39;t deal with long filenames so we have to use the prefix &#39;\\\\?\\&#39;</span>
        <span class="c1"># if len(filename.split(&#39;\\\\?\\&#39;)) == 1:</span>
        <span class="c1">#     filename = &#39;\\\\?\\&#39; + filename</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_data</span><span class="p">:</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span></div>
<div class="viewcode-block" id="Script.save_b26"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.save_b26">[docs]</a>    <span class="k">def</span> <span class="nf">save_b26</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        saves the script settings to a file: filename is filename is not provided, it is created from internal function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="s1">&#39;.b26&#39;</span><span class="p">)</span>

        <span class="c1"># if platform.system() == &#39;Windows&#39;:</span>
        <span class="c1">#     # windows can&#39;t deal with long filenames so we have to use the prefix &#39;\\\\?\\&#39;</span>
        <span class="c1">#     if len(filename.split(&#39;\\\\?\\&#39;)) == 1:</span>
        <span class="c1">#         filename = &#39;\\\\?\\&#39; + filename</span>
        <span class="n">save_b26_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">scripts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
<div class="viewcode-block" id="Script.save_image_to_disk"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.save_image_to_disk">[docs]</a>    <span class="k">def</span> <span class="nf">save_image_to_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename_1</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filename_2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        creates an image using the scripts plot function and writes it to the disk</span>
<span class="sd">        for single plots (plot_type: &#39;main&#39;, &#39;aux&#39;)</span>
<span class="sd">            - if no filname provided take default name</span>
<span class="sd">        for double plots (plot_type: &#39;main&#39;, &#39;aux&#39;)</span>
<span class="sd">            - if no filnames provided take default name</span>
<span class="sd">            - if only one filname provided save only the plot for which name is provided</span>
<span class="sd">        Args:</span>
<span class="sd">            filename_1: filname for figure 1</span>
<span class="sd">            filename_2: filname for figure 1</span>

<span class="sd">        Returns: None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">axes_empty</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            takes an axes object and checks if it is empty</span>
<span class="sd">            the axes object is considered empty it doesn&#39;t contain any of the following:</span>
<span class="sd">                - lines</span>
<span class="sd">                - images</span>
<span class="sd">                - patches</span>
<span class="sd">            Returns:</span>

<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">is_empty</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">images</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">patches</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">is_empty</span> <span class="o">=</span> <span class="kc">False</span>


            <span class="k">return</span> <span class="n">is_empty</span>

        <span class="c1"># create and save images</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">filename_1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">filename_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="s1">&#39;-plt1.png&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">filename_2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">filename_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="s1">&#39;-plt2.png&#39;</span><span class="p">)</span>


        <span class="c1"># windows can&#39;t deal with long filenames so we have to use the prefix &#39;\\\\?\\&#39;</span>
        <span class="c1"># if len(filename_1.split(&#39;\\\\?\\&#39;)) == 1:</span>
        <span class="c1">#     filename_1 = &#39;\\\\?\\&#39; + filename_1</span>
        <span class="c1"># if len(filename_2.split(&#39;\\\\?\\&#39;)) == 1:</span>
        <span class="c1">#     filename_2 = &#39;\\\\?\\&#39; + filename_2</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename_1</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename_1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename_2</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename_2</span><span class="p">))</span>


        <span class="n">fig_1</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">()</span>
        <span class="n">canvas_1</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig_1</span><span class="p">)</span>

        <span class="n">fig_2</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">()</span>
        <span class="n">canvas_2</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig_2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">force_update</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">fig_1</span><span class="p">,</span> <span class="n">fig_2</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">filename_1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">axes_empty</span><span class="p">(</span><span class="n">fig_1</span><span class="o">.</span><span class="n">axes</span><span class="p">):</span>
            <span class="n">fig_1</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename_1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">axes_empty</span><span class="p">(</span><span class="n">fig_2</span><span class="o">.</span><span class="n">axes</span><span class="p">):</span>
            <span class="n">fig_2</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename_2</span><span class="p">)</span></div>

<div class="viewcode-block" id="Script.save"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        saves the instance of the script to a file using pickle</span>
<span class="sd">        Args:</span>
<span class="sd">            filename: target filename</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="s1">&#39;.b26s&#39;</span><span class="p">)</span>
        <span class="c1"># if len(filename.split(&#39;\\\\?\\&#39;)) == 1:</span>
        <span class="c1">#     filename = &#39;\\\\?\\&#39; + filename</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">))</span></div>

<div class="viewcode-block" id="Script.load"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.load">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">instruments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        loads an script instance using pickle</span>
<span class="sd">        Args:</span>
<span class="sd">            filename: source filename</span>
<span class="sd">            instruments:</span>
<span class="sd">                optional - only needed if script requires instruments</span>
<span class="sd">                dictionary of form</span>

<span class="sd">                instruments = {</span>
<span class="sd">                name_of_instrument_1 : instance_of_instrument_1,</span>
<span class="sd">                name_of_instrument_2 : instance_of_instrument_2,</span>
<span class="sd">                ...</span>
<span class="sd">                }</span>
<span class="sd">        Returns:</span>
<span class="sd">            script_instance</span>
<span class="sd">            updated_instruments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
            <span class="n">dataPickle</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">script_as_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dataPickle</span><span class="p">)</span>
        <span class="n">script_class</span> <span class="o">=</span> <span class="n">script_as_dict</span><span class="p">[</span><span class="s1">&#39;_script_class&#39;</span><span class="p">]</span>

        <span class="n">script_instance</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">updated_instruments</span> <span class="o">=</span> <span class="n">Script</span><span class="o">.</span><span class="n">load_and_append</span><span class="p">({</span><span class="s1">&#39;script&#39;</span><span class="p">:</span> <span class="n">script_class</span><span class="p">},</span> <span class="n">instruments</span> <span class="o">=</span> <span class="n">instruments</span><span class="p">)</span>
        <span class="n">script_instance</span> <span class="o">=</span> <span class="n">script_instance</span><span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">]</span>

        <span class="c1"># save references to instruments</span>
        <span class="n">instruments</span> <span class="o">=</span> <span class="n">script_instance</span><span class="o">.</span><span class="n">_instruments</span>

        <span class="c1"># update the script instance</span>
        <span class="n">script_instance</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">script_as_dict</span>

        <span class="c1"># update references to instruments</span>
        <span class="n">script_instance</span><span class="o">.</span><span class="n">_instruments</span> <span class="o">=</span> <span class="n">instruments</span>

        <span class="k">return</span> <span class="n">script_instance</span><span class="p">,</span> <span class="n">updated_instruments</span></div>

<div class="viewcode-block" id="Script.load_data"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.load_data">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        loads the data that has been save with Script.save.</span>
<span class="sd">        Args:</span>
<span class="sd">            path: path to folder saved by Script.save or raw_data folder within</span>
<span class="sd">        Returns:</span>
<span class="sd">            a dictionary with the data of form</span>
<span class="sd">            data = {param_1_name: param_1_data, ...}</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># check that path exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Path given does not exist!&#39;</span><span class="p">)</span>

        <span class="c1"># windows can&#39;t deal with long filenames (&gt;260 chars) so we have to use the prefix &#39;\\\\?\\&#39;</span>
        <span class="c1"># if len(path.split(&#39;\\\\?\\&#39;)) == 1:</span>
        <span class="c1">#     path = &#39;\\\\?\\&#39; + os.path.abspath(path)</span>


        <span class="c1"># if raw_data folder exists, get a list of directories from within it; otherwise, get names of all .csv files in</span>
        <span class="c1"># current directory</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># if self.RAW_DATA_DIR in os.listdir(path): #8/26/16 AK: self not defined in static context</span>
        <span class="c1">#     data_files = os.listdir(os.path.join(path, self.RAW_DATA_DIR + &#39;/&#39;))</span>
        <span class="c1">#     path = os.path.join(path, self.RAW_DATA_DIR + &#39;/&#39;)</span>
        <span class="c1">#</span>
        <span class="c1"># else:</span>
        <span class="k">if</span> <span class="s1">&#39;raw_data&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>  <span class="c1">#temporarily hardcoded</span>
            <span class="n">data_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;raw_data&#39;</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;raw_data&#39;</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;*.csv&#39;</span><span class="p">))</span>

        <span class="c1"># If no data files were found, raise error</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Could not find data files in </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

        <span class="c1"># import data from each csv</span>
        <span class="k">for</span> <span class="n">data_file</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">:</span>
            <span class="c1"># get data name, read the data from the csv, and save it to dictionary</span>
            <span class="n">data_name</span> <span class="o">=</span> <span class="n">data_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># JG: why do we strip of the date?</span>
            <span class="n">imported_data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data_file</span><span class="p">))</span>

            <span class="c1"># check if there are real headers, if the headers are digits than we ignore them because then they are just indecies</span>
            <span class="c1"># real headers are strings (however, the digits are also of type str! that why we use the isdigit method)</span>
            <span class="n">column_headers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">imported_data_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">column_headers</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_headers</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">data_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">h</span><span class="p">:</span> <span class="n">imported_data_df</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">column_headers</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># note, np.squeeze removes extraneous length-1 dimensions from the returned &#39;matrix&#39; from the dataframe</span>
                <span class="n">data</span><span class="p">[</span><span class="n">data_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">imported_data_df</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Script.load_settings"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.load_settings">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_settings</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">setttings_only</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        loads the settings that has been save with Script.save_b26.</span>
<span class="sd">        Args:</span>
<span class="sd">            path: path to folder saved by Script.save_b26</span>
<span class="sd">            setttings_only: if true returns only the settings if the .b26 file contains only a single script</span>
<span class="sd">        Returns:</span>
<span class="sd">            a dictionary with the settings</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># check that path exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Path given does not exist!&#39;</span><span class="p">)</span>

        <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">:])</span>

        <span class="n">search_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/*&#39;</span><span class="o">+</span><span class="n">tag</span> <span class="o">+</span><span class="s1">&#39;.b26&#39;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">search_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;warning more than one .b26 file found, loading &#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;no .b26 file found in folder </span><span class="si">{:s}</span><span class="s1">,  check path !&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">search_str</span><span class="p">)))</span>
            <span class="k">return</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">load_b26_file</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="s1">&#39;scripts&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">setttings_only</span><span class="p">:</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">settings</span></div>

<div class="viewcode-block" id="Script.load_and_append"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.load_and_append">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_and_append</span><span class="p">(</span><span class="n">script_dict</span><span class="p">,</span> <span class="n">scripts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">instruments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">raise_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s1">&#39;pylabcontrol&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load script from script_dict and append to scripts, if additional instruments are required create them and add them to instruments</span>

<span class="sd">        Args:</span>
<span class="sd">            script_dict: dictionary of form</span>

<span class="sd">                script_dict = {</span>
<span class="sd">                name_of_script_1 :</span>
<span class="sd">                    {&quot;settings&quot; : settings_dictionary, &quot;class&quot; : name_of_class}</span>
<span class="sd">                name_of_instrument_2 :</span>
<span class="sd">                    {&quot;settings&quot; : settings_dictionary, &quot;class&quot; : name_of_class}</span>
<span class="sd">                ...</span>
<span class="sd">                }</span>

<span class="sd">            or</span>

<span class="sd">                script_dict = {</span>
<span class="sd">                name_of_script_1 : name_of_class,</span>
<span class="sd">                name_of_script_2 : name_of_class</span>
<span class="sd">                ...</span>
<span class="sd">                }</span>

<span class="sd">            where name_of_class is either a class or the name of a class</span>

<span class="sd">            scripts: dictionary of form</span>

<span class="sd">                scripts = {</span>
<span class="sd">                name_of_script_1 : instance_of_script_1,</span>
<span class="sd">                name_of_script_2 : instance_of_script_2,</span>
<span class="sd">                ...</span>
<span class="sd">                }</span>

<span class="sd">            instruments: dictionary of form</span>

<span class="sd">                instruments = {</span>
<span class="sd">                name_of_instrument_1 : instance_of_instrument_1,</span>
<span class="sd">                name_of_instrument_2 : instance_of_instrument_2,</span>
<span class="sd">                ...</span>
<span class="sd">                }</span>
<span class="sd">            log_function: function that takes a string</span>

<span class="sd">            data_path: absolute path where data is saved, in case the path in the script is definded as a relative path</span>

<span class="sd">            raise_errors: if True errors are raised</span>
<span class="sd">        Returns:</span>
<span class="sd">                dictionary of form</span>
<span class="sd">                script_dict = { name_of_script_1 : script_1_instance, name_of_script_2 : script_2_instance, ...}</span>
<span class="sd">                load_failed = {name_of_script_1: exception_1, name_of_script_2: exception_2, ....}</span>
<span class="sd">                updated_instruments = {name_of_instrument_1 : instance_of_instrument_1, ..}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">scripts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scripts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">instruments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">instruments</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">load_failed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">updated_scripts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">updated_scripts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scripts</span><span class="p">)</span>
        <span class="n">updated_instruments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">updated_instruments</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">instruments</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;script_dict&#39;</span><span class="p">,</span> <span class="n">script_dict</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">get_instruments</span><span class="p">(</span><span class="n">class_of_script</span><span class="p">,</span> <span class="n">script_instruments</span><span class="p">,</span> <span class="n">instruments</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            creates the dictionary with the instruments needed for the script and update the instrument dictionary if new instruments are required</span>

<span class="sd">            Args:</span>
<span class="sd">                class_of_script: the class of the script</span>
<span class="sd">                instruments: the instruments that have been loaded already</span>

<span class="sd">            Returns: dictionary with the instruments that the script needs and the updated instruments dictionary</span>

<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">default_instruments</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">class_of_script</span><span class="p">,</span> <span class="s1">&#39;_INSTRUMENTS&#39;</span><span class="p">)</span>
            <span class="n">instrument_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">instruments_updated</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">instruments_updated</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">instruments</span><span class="p">)</span>
            <span class="c1"># check if instruments needed by script already exist, if not create an instance</span>
            <span class="k">for</span> <span class="n">instrument_name</span><span class="p">,</span> <span class="n">instrument_class</span> <span class="ow">in</span> <span class="n">default_instruments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># check if instruments needed by script already exist</span>
                <span class="n">instrument</span> <span class="o">=</span> <span class="p">[</span><span class="n">instance</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instruments_updated</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span>
                              <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">instrument_class</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="n">instrument_name</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># create new instance of instrument</span>
                    <span class="n">instruments_updated</span><span class="p">,</span> <span class="n">__</span> <span class="o">=</span> <span class="n">Instrument</span><span class="o">.</span><span class="n">load_and_append</span><span class="p">({</span><span class="n">instrument_name</span><span class="p">:</span> <span class="n">instrument_class</span><span class="p">},</span> <span class="n">instruments_updated</span><span class="p">,</span> <span class="n">raise_errors</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">script_instruments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">instrument_name</span> <span class="ow">in</span> <span class="n">script_instruments</span><span class="p">:</span>
                    <span class="n">instrument_settings_dict</span> <span class="o">=</span> <span class="n">script_instruments</span><span class="p">[</span><span class="n">instrument_name</span><span class="p">][</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">instrument_settings_dict</span> <span class="o">=</span> <span class="n">instruments_updated</span><span class="p">[</span><span class="n">instrument_name</span><span class="p">]</span><span class="o">.</span><span class="n">settings</span>

                <span class="n">instrument_instance</span> <span class="o">=</span> <span class="n">instruments_updated</span><span class="p">[</span><span class="n">instrument_name</span><span class="p">]</span>

                <span class="c1"># make a deepcopy of _DEFAULT_SETTINGS to get a parameter object</span>
                <span class="n">instrument_settings</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">instrument_instance</span><span class="o">.</span><span class="n">_DEFAULT_SETTINGS</span><span class="p">)</span>

                <span class="c1">#now update parameter object with new values</span>
                <span class="n">instrument_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">instrument_settings_dict</span><span class="p">)</span>

                <span class="n">instrument_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">instrument_name</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;instance&quot;</span><span class="p">:</span><span class="n">instrument_instance</span><span class="p">,</span> <span class="s2">&quot;settings&quot;</span><span class="p">:</span><span class="n">instrument_settings</span><span class="p">}})</span>


            <span class="k">return</span> <span class="n">instrument_dict</span><span class="p">,</span> <span class="n">instruments_updated</span>

        <span class="k">def</span> <span class="nf">get_sub_scripts</span><span class="p">(</span><span class="n">class_of_script</span><span class="p">,</span> <span class="n">instruments</span><span class="p">,</span> <span class="n">sub_scripts_dict</span><span class="p">,</span> <span class="n">log_function</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            creates the dictionary with the sub scripts needed by the script and updates the instrument dictionary if new instruments are required</span>

<span class="sd">            Args:</span>
<span class="sd">                class_of_script: the class of the script</span>
<span class="sd">                instruments: the instruments that have been loaded already</span>
<span class="sd">                sub_scripts_dict: settings of script in dictionary form</span>

<span class="sd">            Returns:dictionary with the sub scripts that the script needs</span>

<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">default_scripts</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">class_of_script</span><span class="p">,</span> <span class="s1">&#39;_SCRIPTS&#39;</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># create instruments that script needs</span>
            <span class="n">sub_scripts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sub_scripts</span><span class="p">,</span> <span class="n">scripts_failed</span><span class="p">,</span> <span class="n">instruments_updated</span> <span class="o">=</span> <span class="n">Script</span><span class="o">.</span><span class="n">load_and_append</span><span class="p">(</span><span class="n">default_scripts</span><span class="p">,</span> <span class="n">sub_scripts</span><span class="p">,</span>
                                                                                      <span class="n">instruments</span><span class="p">,</span>
                                                                                      <span class="n">log_function</span><span class="o">=</span><span class="n">log_function</span><span class="p">,</span>
                                                                                      <span class="n">raise_errors</span><span class="o">=</span><span class="n">raise_errors</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sub_scripts_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sub_scripts_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1">#update settings, updates instrument and settings</span>
                        <span class="n">sub_scripts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="c1">#if actually an object, as with dynamic scripts</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scripts_failed</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;script </span><span class="si">{:s}</span><span class="s1">: failed to load subscripts&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_of_script</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">sub_scripts</span><span class="p">,</span> <span class="n">instruments_updated</span>

        <span class="k">for</span> <span class="n">script_name</span><span class="p">,</span> <span class="n">script_info</span> <span class="ow">in</span> <span class="n">script_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="c1"># check if script already exists</span>
            <span class="k">if</span> <span class="n">script_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">scripts</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;WARNING: script </span><span class="si">{:s}</span><span class="s1"> already exists. Did not load!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_name</span><span class="p">)))</span>
                <span class="n">load_failed</span><span class="p">[</span><span class="n">script_name</span><span class="p">]</span> <span class="o">=</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;script </span><span class="si">{:s}</span><span class="s1"> already exists. Did not load!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">module</span><span class="p">,</span> <span class="n">script_class_name</span><span class="p">,</span> <span class="n">script_settings</span><span class="p">,</span> <span class="n">script_instruments</span><span class="p">,</span> <span class="n">script_sub_scripts</span><span class="p">,</span> <span class="n">script_doc</span><span class="p">,</span> <span class="n">package</span> <span class="o">=</span> <span class="n">Script</span><span class="o">.</span><span class="n">get_script_information</span><span class="p">(</span><span class="n">script_info</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="n">package</span><span class="p">)</span>
                <span class="c1"># creates all dynamic scripts so they can be imported following the if statement</span>
                <span class="c1"># if script_class_name == &#39;ScriptIterator&#39;:</span>
                <span class="k">if</span> <span class="s1">&#39;ScriptIterator&#39;</span> <span class="ow">in</span> <span class="n">script_class_name</span><span class="p">:</span>
                    <span class="c1"># creates all the dynamic classes in the script and the class of the script itself</span>
                    <span class="c1"># and updates the script info with these new classes</span>
                    <span class="kn">from</span> <span class="nn">pylabcontrol.core.script_iterator</span> <span class="k">import</span> <span class="n">ScriptIterator</span> <span class="c1">#CAUTION: imports ScriptIterator, which inherits from script. Local scope should avoid circular imports.</span>

                    <span class="n">script_info</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ScriptIterator</span><span class="o">.</span><span class="n">create_dynamic_script_class</span><span class="p">(</span><span class="n">script_info</span><span class="p">)</span>

                    <span class="c1"># now get the info for the dynamically created class</span>
                    <span class="n">module</span><span class="p">,</span> <span class="n">script_class_name</span><span class="p">,</span> <span class="n">script_settings</span><span class="p">,</span> <span class="n">script_instruments</span><span class="p">,</span> <span class="n">script_sub_scripts</span><span class="p">,</span> <span class="n">script_doc</span><span class="p">,</span> <span class="n">package</span> <span class="o">=</span> <span class="n">Script</span><span class="o">.</span><span class="n">get_script_information</span><span class="p">(</span><span class="n">script_info</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;load_and_append.module&#39;</span><span class="p">,</span> <span class="n">module</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;load_and_append.script_info&#39;</span><span class="p">,</span> <span class="n">script_info</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;load_and_append.package&#39;</span><span class="p">,</span> <span class="n">package</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">script_info</span><span class="p">):</span>
                    <span class="n">class_of_script</span> <span class="o">=</span> <span class="n">script_info</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">class_of_script</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">script_class_name</span><span class="p">)</span>

                <span class="c1">#  ========= create the instruments that are needed by the script =========</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">script_instruments</span><span class="p">,</span> <span class="n">updated_instruments</span> <span class="o">=</span> <span class="n">get_instruments</span><span class="p">(</span><span class="n">class_of_script</span><span class="p">,</span> <span class="n">script_instruments</span><span class="p">,</span> <span class="n">updated_instruments</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;loading script </span><span class="si">{:s}</span><span class="s1"> failed. Could not load instruments!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_name</span><span class="p">)))</span>
                    <span class="n">load_failed</span><span class="p">[</span><span class="n">script_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span>
                    <span class="k">if</span> <span class="n">raise_errors</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">err</span>
                    <span class="k">continue</span>
                <span class="c1">#  ========= create the subscripts that are needed by the script =========</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sub_scripts</span><span class="p">,</span> <span class="n">updated_instruments</span> <span class="o">=</span> <span class="n">get_sub_scripts</span><span class="p">(</span><span class="n">class_of_script</span><span class="p">,</span> <span class="n">updated_instruments</span><span class="p">,</span> <span class="n">script_sub_scripts</span><span class="p">,</span> <span class="n">log_function</span> <span class="o">=</span> <span class="n">log_function</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;loading script </span><span class="si">{:s}</span><span class="s1"> failed. Could not load subscripts!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_name</span><span class="p">)))</span>
                    <span class="n">load_failed</span><span class="p">[</span><span class="n">script_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span>
                    <span class="k">if</span> <span class="n">raise_errors</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">err</span>
                    <span class="k">continue</span>

                <span class="c1">#  ========= create the script if instruments and subscripts have been loaded successfully =========</span>
                <span class="n">class_creation_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">script_instruments</span><span class="p">:</span>
                    <span class="n">class_creation_string</span> <span class="o">+=</span> <span class="s1">&#39;, instruments = script_instruments&#39;</span>
                <span class="k">if</span> <span class="n">sub_scripts</span><span class="p">:</span>
                    <span class="n">class_creation_string</span> <span class="o">+=</span> <span class="s1">&#39;, scripts = sub_scripts&#39;</span>
                <span class="k">if</span> <span class="n">script_settings</span><span class="p">:</span>
                    <span class="n">class_creation_string</span> <span class="o">+=</span> <span class="s1">&#39;, settings = script_settings&#39;</span>
                <span class="k">if</span> <span class="n">log_function</span><span class="p">:</span>
                    <span class="n">class_creation_string</span> <span class="o">+=</span> <span class="s1">&#39;, log_function = log_function&#39;</span>
                <span class="k">if</span> <span class="n">data_path</span><span class="p">:</span>
                    <span class="n">class_creation_string</span> <span class="o">+=</span> <span class="s1">&#39;, data_path = data_path&#39;</span>
                <span class="n">class_creation_string</span> <span class="o">=</span> <span class="s1">&#39;class_of_script(name=script_name</span><span class="si">{:s}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_creation_string</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;class_creation_string&#39;</span><span class="p">,</span> <span class="n">class_creation_string</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;class_of_script&#39;</span><span class="p">,</span> <span class="n">class_of_script</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;scripts&#39;</span><span class="p">,</span> <span class="n">sub_scripts</span><span class="p">))</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">script_instance</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">class_creation_string</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;loading script </span><span class="si">{:s}</span><span class="s1"> failed. Could not create instance of script!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_name</span><span class="p">)))</span>
                    <span class="n">load_failed</span><span class="p">[</span><span class="n">script_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span>
                    <span class="k">if</span> <span class="n">raise_errors</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">err</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">script_doc</span><span class="p">:</span>
                    <span class="n">script_instance</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">script_doc</span>

                <span class="n">updated_scripts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">script_name</span><span class="p">:</span> <span class="n">script_instance</span><span class="p">})</span>


        <span class="k">return</span> <span class="n">updated_scripts</span><span class="p">,</span> <span class="n">load_failed</span><span class="p">,</span> <span class="n">updated_instruments</span></div>

<div class="viewcode-block" id="Script.get_script_information"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.get_script_information">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_script_information</span><span class="p">(</span><span class="n">script_information</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s1">&#39;pylabcontrol&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        extracts all the relevant information from script_information and returns it as individual variables</span>
<span class="sd">        Args:</span>
<span class="sd">            script_information: information of the script. This can be</span>
<span class="sd">                - a dictionary</span>
<span class="sd">                - a Script instance</span>
<span class="sd">                - name of Script class</span>
<span class="sd">            package (optional): name of the package to which the script belongs, i.e. pylabcontrol or b26toolkit.</span>
<span class="sd">                                Only used when script_information is a string</span>
<span class="sd">        Returns:</span>
<span class="sd">            module, script_class_name, script_settings, script_instruments, script_sub_scripts, script_info, package</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">script_settings</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">script_instruments</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">script_sub_scripts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">script_class_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">module</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># this is the module that contains the script where we look for scripts</span>
        <span class="n">script_info</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># this is the docstring that describes the script</span>
        <span class="n">module_path</span> <span class="o">=</span> <span class="n">package</span> <span class="o">+</span> <span class="s1">&#39;.scripts&#39;</span>
        <span class="n">script_filepath</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">script_information</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;settings&#39;</span> <span class="ow">in</span> <span class="n">script_information</span><span class="p">:</span>
                <span class="n">script_settings</span> <span class="o">=</span> <span class="n">script_information</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;filepath&#39;</span> <span class="ow">in</span> <span class="n">script_information</span><span class="p">:</span>
                <span class="n">script_filepath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">script_information</span><span class="p">[</span><span class="s1">&#39;filepath&#39;</span><span class="p">])</span>
                <span class="n">module_path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">module_name_from_path</span><span class="p">(</span><span class="n">script_filepath</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;package&#39;</span> <span class="ow">in</span> <span class="n">script_information</span><span class="p">:</span>
                <span class="n">package</span> <span class="o">=</span> <span class="n">script_information</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="s1">&#39;filepath&#39;</span> <span class="ow">in</span> <span class="n">script_information</span>  <span class="c1"># there should be a filepath if we load form a b26 file</span>
                <span class="c1"># in the case that we generate the script_information from a .py file the package is given by the name of the highest module</span>
                <span class="k">if</span> <span class="s1">&#39;filepath&#39;</span> <span class="ow">in</span> <span class="n">script_information</span><span class="p">:</span>
                    <span class="n">package</span> <span class="o">=</span> <span class="n">module_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">script_class_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">script_information</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;ScriptIterator&#39;</span> <span class="ow">in</span> <span class="n">script_class_name</span><span class="p">:</span>
                <span class="n">module_path</span> <span class="o">=</span> <span class="n">package</span> <span class="o">+</span> <span class="s1">&#39;.core.script_iterator&#39;</span>

            <span class="k">if</span> <span class="s1">&#39;instruments&#39;</span> <span class="ow">in</span> <span class="n">script_information</span><span class="p">:</span>
                <span class="n">script_instruments</span> <span class="o">=</span> <span class="n">script_information</span><span class="p">[</span><span class="s1">&#39;instruments&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;scripts&#39;</span> <span class="ow">in</span> <span class="n">script_information</span><span class="p">:</span>
                <span class="n">script_sub_scripts</span> <span class="o">=</span> <span class="n">script_information</span><span class="p">[</span><span class="s1">&#39;scripts&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;info&#39;</span> <span class="ow">in</span> <span class="n">script_information</span><span class="p">:</span>
                <span class="n">script_info</span> <span class="o">=</span> <span class="n">script_information</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span>
                
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">script_information</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">script_class_name</span> <span class="o">=</span> <span class="n">script_information</span>


        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">script_information</span><span class="p">,</span> <span class="n">Script</span><span class="p">):</span>
            <span class="c1"># watch out when testing this code from __main__, then classes might not be identified correctly because the path is different</span>
            <span class="c1"># to avoid this problem call from pylabcontrol.core import Script (otherwise the path to Script is __main__.Script)</span>
            <span class="n">script_class_name</span> <span class="o">=</span> <span class="n">script_information</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">package</span> <span class="o">=</span> <span class="n">script_information</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">module_path</span> <span class="o">=</span> <span class="n">script_information</span><span class="o">.</span><span class="vm">__module__</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>


        <span class="c1"># if the script has not been created yet, i.e. script_class_name: ScriptIteratorB26 or ScriptIterator</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;script_filepath&#39;</span><span class="p">,</span> <span class="n">script_filepath</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;path_to_module&#39;</span><span class="p">,</span> <span class="n">module_path</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">script_filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># scriptiterator loaded from file</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">script_filepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.pyc&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;script_iterator&#39;</span><span class="p">:</span>
                <span class="n">module_path</span> <span class="o">=</span> <span class="n">package</span> <span class="o">+</span> <span class="s1">&#39;.core.script_iterator&#39;</span>


        <span class="c1"># if the script has been created already, i.e. script_class_name: package.dynamic_script_iterator</span>
        <span class="c1"># todo: now there is the prefix package</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">script_class_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;dynamic_script_iterator&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> \
                <span class="n">script_class_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;dynamic_script_iterator&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="c1"># package = &#39;pylabcontrol&#39; # all the dynamic iterator scripts are defined in the name space of pylabcontrol</span>
            <span class="c1"># all the dynamic iterator scripts are defined in the name space of package.pylabcontrol.core.script_iterator</span>
            <span class="c1"># module = import_module(package + &#39;.pylabcontrol.core.script_iterator&#39;)</span>
            <span class="n">module_path</span> <span class="o">=</span> <span class="n">package</span>

        <span class="c1"># the package should be the highest level of the module path</span>
        <span class="c1"># assert module_path.split(&#39;.&#39;)[0] == package</span>
        <span class="c1"># assert isinstance(module_path, str)  # in that case we should have defined a module_path to load the module</span>
        <span class="c1"># assert module is None  # we haven&#39;t loaded the module yet</span>

        <span class="c1"># try:</span>
        <span class="c1">#     print(module_path)</span>
        <span class="c1">#     module = import_module(module_path)</span>
        <span class="c1">#     print(module)</span>
        <span class="c1"># except ImportError:</span>
        <span class="c1">#     pass</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="n">module_path</span><span class="p">)</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">module_path</span><span class="p">)</span>
        <span class="c1"># check if module was found!</span>
        <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">script_class_name</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">sys</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;here is the pythonpath&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;Could not find the module that contains &#39;</span> <span class="o">+</span> <span class="n">script_class_name</span> <span class="o">+</span> <span class="s1">&#39; in module &#39;</span> <span class="o">+</span> <span class="n">module_path</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;Could not find the module that contains &#39;</span> <span class="o">+</span> <span class="n">script_class_name</span> <span class="o">+</span> <span class="s1">&#39; in module &#39;</span> <span class="o">+</span> <span class="n">module_path</span><span class="p">)</span>

        <span class="c1"># if the module has a name of type dynamic_script_iteratorX where X is a number the module is script iterator</span>
        <span class="k">return</span> <span class="n">module</span><span class="p">,</span> <span class="n">script_class_name</span><span class="p">,</span> <span class="n">script_settings</span><span class="p">,</span> <span class="n">script_instruments</span><span class="p">,</span> <span class="n">script_sub_scripts</span><span class="p">,</span> <span class="n">script_info</span><span class="p">,</span> <span class="n">package</span></div>

<div class="viewcode-block" id="Script.get_script_module"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.get_script_module">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_script_module</span><span class="p">(</span><span class="n">script_information</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s1">&#39;pylabcontrol&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        wrapper to get the module for a script</span>

<span class="sd">        Args:</span>
<span class="sd">            script_information: information of the script. This can be</span>
<span class="sd">                - a dictionary</span>
<span class="sd">                - a Script instance</span>
<span class="sd">                - name of Script class</span>
<span class="sd">            package (optional): name of the package to which the script belongs, i.e. pylabcontrol or b26toolkit only used when script_information is a string</span>
<span class="sd">        Returns:</span>
<span class="sd">            module</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">module</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Script</span><span class="o">.</span><span class="n">get_script_information</span><span class="p">(</span><span class="n">script_information</span><span class="o">=</span><span class="n">script_information</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="n">package</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">module</span></div>

<div class="viewcode-block" id="Script.duplicate"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.duplicate">[docs]</a>    <span class="k">def</span> <span class="nf">duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create an copy of the script</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get settings of script</span>
        <span class="n">class_of_script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">script_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">script_instruments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span>
        <span class="n">sub_scripts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scripts</span>
        <span class="n">script_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span>
        <span class="n">log_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_function</span>
        <span class="n">data_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span>


        <span class="c1">#create a new instance of same script type</span>
        <span class="n">class_creation_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">script_instruments</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="n">class_creation_string</span> <span class="o">+=</span> <span class="s1">&#39;, instruments = script_instruments&#39;</span>
        <span class="k">if</span> <span class="n">sub_scripts</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="n">class_creation_string</span> <span class="o">+=</span> <span class="s1">&#39;, scripts = sub_scripts&#39;</span>
        <span class="k">if</span> <span class="n">script_settings</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="n">class_creation_string</span> <span class="o">+=</span> <span class="s1">&#39;, settings = script_settings&#39;</span>
        <span class="k">if</span> <span class="n">log_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">class_creation_string</span> <span class="o">+=</span> <span class="s1">&#39;, log_function = log_function&#39;</span>
        <span class="k">if</span> <span class="n">data_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">class_creation_string</span> <span class="o">+=</span> <span class="s1">&#39;, data_path = data_path&#39;</span>
        <span class="n">class_creation_string</span> <span class="o">=</span> <span class="s1">&#39;class_of_script(name=script_name</span><span class="si">{:s}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_creation_string</span><span class="p">)</span>
        <span class="c1"># create instance</span>
        <span class="n">script_instance</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">class_creation_string</span><span class="p">)</span>

        <span class="c1"># copy some other properties that might be checked later for the duplicated script</span>
        <span class="n">script_instance</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">script_instance</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
        <span class="n">script_instance</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span>
        <span class="n">script_instance</span><span class="o">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span>

        <span class="k">return</span> <span class="n">script_instance</span></div>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plots the data only the axes objects that are provided in axes_list</span>
<span class="sd">        Args:</span>
<span class="sd">            axes_list: a list of axes objects, this should be implemented in each subscript</span>

<span class="sd">        Returns: None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
        <span class="c1"># not sure if to raise a not implemented error or just give a warning. For now just warning</span>
        <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;INFO: </span><span class="si">{:s}</span><span class="s1"> called _plot even though it is not implemented&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_update_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        updates the data in already existing plots. the axes objects are provided in axes_list</span>
<span class="sd">        Args:</span>
<span class="sd">            axes_list: a list of axes objects, this should be implemented in each subscript</span>

<span class="sd">        Returns: None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># default behaviour just calls the standard plot function that creates a new image everytime it is called</span>
        <span class="c1"># for heavier plots such as images implement a function here that updates only the date of the plot</span>
        <span class="c1"># but doesn&#39;t create a whole new image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot</span><span class="p">(</span><span class="n">axes_list</span><span class="p">)</span>


<div class="viewcode-block" id="Script.force_update"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.force_update">[docs]</a>    <span class="k">def</span> <span class="nf">force_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        forces the plot to refresh</span>
<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_refresh</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Script.plot"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figure_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plots the data contained in self.data, which should be a dictionary or a deque of dictionaries</span>
<span class="sd">        for the latter use the last entry</span>
<span class="sd">        Args:</span>
<span class="sd">            figure_list: list of figure objects that are passed to self.get_axes_layout to get axis objects for plotting</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if there is not data we do not plot anything</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># if plot function is called when script is not running we request a plot refresh</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_refresh</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">axes_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axes_layout</span><span class="p">(</span><span class="n">figure_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_refresh</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot</span><span class="p">(</span><span class="n">axes_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_refresh</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">figure</span> <span class="ow">in</span> <span class="n">figure_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">figure</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
                    <span class="n">figure</span><span class="o">.</span><span class="n">set_tight_layout</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_plot</span><span class="p">(</span><span class="n">axes_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="Script.get_axes_layout"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.get_axes_layout">[docs]</a>    <span class="k">def</span> <span class="nf">get_axes_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figure_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the axes objects the script needs to plot its data</span>
<span class="sd">        the default creates a single axes object on each figure</span>
<span class="sd">        This can/should be overwritten in a child script if more axes objects are needed</span>
<span class="sd">        Args:</span>
<span class="sd">            figure_list: a list of figure objects</span>
<span class="sd">        Returns:</span>
<span class="sd">            axes_list: a list of axes objects</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axes_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_refresh</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figure_list</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="n">axes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figure_list</span><span class="p">:</span>
                <span class="n">axes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">axes_list</span></div>

<div class="viewcode-block" id="Script.plot_validate"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.plot_validate">[docs]</a>    <span class="k">def</span> <span class="nf">plot_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figure_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plots the data contained in self.data, which should be a dictionary or a deque of dictionaries</span>
<span class="sd">        for the latter use the last entry</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axes_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axes_layout_validate</span><span class="p">(</span><span class="n">figure_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_validate</span><span class="p">(</span><span class="n">axes_list</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_plot_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plot some visual output as a result of the validation (see self.validate)</span>
<span class="sd">        This will most likely be removed in future version: instead preview function, maybe</span>
<span class="sd">        :param axes_list: list of axes objects on which to plot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Script.get_axes_layout_validate"><a class="viewcode-back" href="../../../code_docs/pylabcontrol.core.html#pylabcontrol.core.scripts.Script.get_axes_layout_validate">[docs]</a>    <span class="k">def</span> <span class="nf">get_axes_layout_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figure_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        creates the axes layout for the validation plots</span>
<span class="sd">        :param figure_list: list of figures</span>
<span class="sd">        :return: list of axes objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axes_layout</span><span class="p">(</span><span class="n">figure_list</span><span class="p">)</span></div></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>


    <span class="c1"># # test for get_script_information</span>
    <span class="c1"># sinfo = {&#39;info&#39;: &#39;\nExample Script that has all different types of parameters (integer, str, fload, point, list of parameters). Plots 1D and 2D data.\n    &#39;,</span>
    <span class="c1">#                                          &#39;settings&#39;: {&#39;count&#39;: 3, &#39;name&#39;: &#39;this is a counter&#39;, &#39;wait_time&#39;: 0.1, &#39;point2&#39;: {&#39;y&#39;: 0.1, &#39;x&#39;: 0.1}, &#39;tag&#39;: &#39;scriptdummy&#39;, &#39;path&#39;: &#39;&#39;,</span>
    <span class="c1">#                                                       &#39;save&#39;: False, &#39;plot_style&#39;: &#39;main&#39;},</span>
    <span class="c1">#                                          &#39;class&#39;: &#39;ScriptDummy&#39;, &#39;filepath&#39;: &#39;/Users/rettentulla/PycharmProjects/pylabcontrol/pylabcontrol/scripts/script_dummy.py&#39;}</span>
    <span class="c1">#</span>
    <span class="c1"># info = Script.get_script_information(sinfo, verbose=True)</span>
    <span class="c1">#</span>
    <span class="c1"># print(info)</span>
    <span class="c1">#</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Arthur Safira, Jan Gieseler, Aaron Kabcenell.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>